{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
	<h1 class="h4 m-0">Outstanding Report</h1>
	<div>
		<a class="btn btn-outline-secondary btn-sm me-2" href="#" onclick="window.print()"><i class="fa-solid fa-print me-1"></i> Print/PDF</a>
		<a class="btn btn-outline-success btn-sm" href="#"><i class="fa-solid fa-file-excel me-1"></i> Export Excel</a>
	</div>
</div>

<form method="get" class="card mb-3">
	<div class="card-body">
		<div class="row g-2 align-items-end">
			<div class="col-6 col-md-3">
				<label class="form-label">Start Date</label>
				<input class="form-control" type="date" name="start" value="{{ request.args.get('start', '') }}">
			</div>
			<div class="col-6 col-md-3">
				<label class="form-label">End Date</label>
				<input class="form-control" type="date" name="end" value="{{ request.args.get('end', '') }}">
			</div>
			<div class="col-12 col-md-3">
				<label class="form-label">Customer</label>
				<select class="form-select" name="customer_id">
					<option value="">All</option>
					{% for c in customers %}
					<option value="{{ c.id }}" {{ 'selected' if sel_customer==c.id else '' }}>{{ c.name }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-12 col-md-2">
				<label class="form-label">Status</label>
				<select class="form-select" name="status">
					<option value="" {{ 'selected' if sel_status=='' else '' }}>All</option>
					<option value="paid" {{ 'selected' if sel_status=='paid' else '' }}>Paid</option>
					<option value="partial" {{ 'selected' if sel_status=='partial' else '' }}>Partially Paid</option>
					<option value="unpaid" {{ 'selected' if sel_status=='unpaid' else '' }}>Unpaid</option>
				</select>
			</div>
			<div class="col-12 col-md-1">
				<button class="btn btn-primary w-100"><i class="fa-solid fa-filter me-1"></i> Go</button>
			</div>
		</div>
	</div>
</form>

<div class="row g-3 mb-3">
	<div class="col-12 col-md-4">
		<div class="card card-kpi"><div class="card-body">
			<p class="text-muted mb-1">Total Invoices</p>
			<h3 class="m-0">{{ 'Rs ' ~ '%.0f'|format(total_invoices or 0) }}</h3>
		</div></div>
	</div>
	<div class="col-12 col-md-4">
		<div class="card card-kpi"><div class="card-body">
			<p class="text-muted mb-1">Total Payments</p>
			<h3 class="m-0">{{ 'Rs ' ~ '%.0f'|format(total_payments or 0) }}</h3>
		</div></div>
	</div>
	<div class="col-12 col-md-4">
		<div class="card card-kpi"><div class="card-body">
			<p class="text-muted mb-1">Outstanding</p>
			<h3 class="m-0">{{ 'Rs ' ~ '%.0f'|format(outstanding or 0) }}</h3>
		</div></div>
	</div>
</div>

<div class="card">
	<div class="table-responsive">
		<table class="table table-hover align-middle datatable">
			<thead class="table-light">
				<tr>
					<th>Customer Name</th>
					<th>Invoice #</th>
					<th>Invoice Date</th>
					<th>Total Amount</th>
					<th>Payments Received</th>
					<th>Remaining Outstanding</th>
					<th>Due Date</th>
					<th>Status</th>
				</tr>
			</thead>
			<tbody>
				{% for r in rows %}
				<tr>
					<td>{{ r.customer }}</td>
					<td><a href="/invoices/{{ r.id }}">{{ r.invoice_number }}</a></td>
					<td>{{ r.date.strftime('%Y-%m-%d') }}</td>
					<td>{{ 'Rs ' ~ '%.0f'|format(r.total) }}</td>
					<td>{{ 'Rs ' ~ '%.0f'|format(r.paid) }}</td>
					<td class="{{ 'text-success' if r.status=='paid' else ('text-warning' if r.status=='partial' else 'text-danger') }}">{{ 'Rs ' ~ '%.0f'|format(r.outstanding) }}</td>
					<td>{{ r.due_date.strftime('%Y-%m-%d') if r.due_date else '-' }}</td>
					<td>
						<span class="badge {{ 'text-bg-success' if r.status=='paid' else ('text-bg-warning' if r.status=='partial' else 'text-bg-danger') }}">{{ r.status|title }}</span>
					</td>
				</tr>
				{% else %}
				<tr><td colspan="8" class="text-center text-muted">No records</td></tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>
{% endblock %}
