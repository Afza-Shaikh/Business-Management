{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
	<h1 class="h4 m-0">Payment History</h1>
	<div>
		<a class="btn btn-outline-success me-2" href="#" onclick="window.print()">
			<i class="fa-solid fa-print me-1"></i> Print/PDF
		</a>
		<a class="btn btn-outline-primary" href="#" onclick="exportToExcel()">
			<i class="fa-solid fa-file-excel me-1"></i> Export Excel
		</a>
	</div>
</div>

<!-- Filters -->
<div class="card mb-3">
	<div class="card-body">
		<form method="get" class="row g-2 align-items-end">
			<div class="col-12 col-md-3">
				<label class="form-label">Customer</label>
				<select class="form-select" name="customer_id">
					<option value="">All Customers</option>
					{% for customer in customers %}
					<option value="{{ customer.id }}" {{ 'selected' if selected_customer|string == customer.id|string else '' }}>
						{{ customer.name }}
					</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-12 col-md-2">
				<label class="form-label">Start Date</label>
				<input type="date" class="form-control" name="start_date" value="{{ start_date or '' }}">
			</div>
			<div class="col-12 col-md-2">
				<label class="form-label">End Date</label>
				<input type="date" class="form-control" name="end_date" value="{{ end_date or '' }}">
			</div>
			<div class="col-12 col-md-2">
				<label class="form-label">Payment Method</label>
				<select class="form-select" name="payment_method">
					<option value="">All Methods</option>
					<option value="Cash" {{ 'selected' if selected_method == 'Cash' else '' }}>Cash</option>
					<option value="Bank Transfer" {{ 'selected' if selected_method == 'Bank Transfer' else '' }}>Bank Transfer</option>
					<option value="Cheque" {{ 'selected' if selected_method == 'Cheque' else '' }}>Cheque</option>
					<option value="Digital Wallet" {{ 'selected' if selected_method == 'Digital Wallet' else '' }}>Digital Wallet</option>
				</select>
			</div>
			<div class="col-12 col-md-2">
				<button type="submit" class="btn btn-primary w-100">
					<i class="fa-solid fa-filter me-1"></i> Filter
				</button>
			</div>
			<div class="col-12 col-md-1">
				<a href="{{ url_for('billing.payment_history') }}" class="btn btn-outline-secondary w-100">
					<i class="fa-solid fa-refresh"></i>
				</a>
			</div>
		</form>
	</div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
	<div class="col-12 col-md-3">
		<div class="card card-kpi">
			<div class="card-body">
				<p class="text-muted mb-1">Total Payments</p>
				<h3 class="m-0">{{ payments|length }}</h3>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card card-kpi">
			<div class="card-body">
				<p class="text-muted mb-1">Total Amount</p>
				<h3 class="m-0">{{ 'Rs ' ~ '%.0f'|format(payments|sum(attribute='amount')) }}</h3>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card card-kpi">
			<div class="card-body">
				<p class="text-muted mb-1">Cash Payments</p>
				<h3 class="m-0">{{ payments|selectattr('method', 'equalto', 'Cash')|list|length }}</h3>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card card-kpi">
			<div class="card-body">
				<p class="text-muted mb-1">Bank Transfers</p>
				<h3 class="m-0">{{ payments|selectattr('method', 'equalto', 'Bank Transfer')|list|length }}</h3>
			</div>
		</div>
	</div>
</div>

<!-- Payment History Table -->
<div class="card">
	<div class="card-header d-flex justify-content-between align-items-center">
		<span>Payment History</span>
		<span class="badge text-bg-primary">{{ payments|length }} Records</span>
	</div>
	<div class="table-responsive">
		<table class="table table-hover align-middle datatable" id="paymentTable">
			<thead class="table-light">
				<tr>
					<th>Date</th>
					<th>Customer</th>
					<th>Invoice No</th>
					<th>Method</th>
					<th>Amount</th>
					<th>Reference</th>
					<th>Status</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				{% for payment in payments %}
				<tr>
					<td>{{ payment.date.strftime('%Y-%m-%d') }}</td>
					<td>
						<div>
							<strong>{{ payment.customer.name }}</strong>
							{% if payment.customer.phone %}
							<br><small class="text-muted">{{ payment.customer.phone }}</small>
							{% endif %}
						</div>
					</td>
					<td>
						{% if payment.invoice %}
							<a href="{{ url_for('invoices.view', invoice_id=payment.invoice.id) }}" class="text-decoration-none">
								{{ payment.invoice.invoice_number }}
							</a>
						{% else %}
							<span class="text-muted">N/A</span>
						{% endif %}
					</td>
					<td>
						<span class="badge {{ 'text-bg-success' if payment.method == 'Cash' else ('text-bg-primary' if payment.method == 'Bank Transfer' else ('text-bg-warning' if payment.method == 'Cheque' else 'text-bg-info')) }}">
							{{ payment.method }}
						</span>
					</td>
					<td class="fw-bold">{{ 'Rs ' ~ '%.0f'|format(payment.amount) }}</td>
					<td>
						{% if payment.notes and 'Ref:' in payment.notes %}
							{{ payment.notes.split('Ref:')[1].strip() }}
						{% else %}
							<span class="text-muted">-</span>
						{% endif %}
					</td>
					<td>
						<span class="badge text-bg-success">
							<i class="fa-solid fa-check me-1"></i>Completed
						</span>
					</td>
					<td>
						<div class="btn-group btn-group-sm">
							{% if payment.invoice %}
							<a href="{{ url_for('invoices.view', invoice_id=payment.invoice.id) }}" class="btn btn-outline-primary" title="View Invoice">
								<i class="fa-solid fa-file-invoice"></i>
							</a>
							{% endif %}
							<button class="btn btn-outline-info" title="View Details" onclick="showPaymentDetails({{ payment.id }})">
								<i class="fa-solid fa-eye"></i>
							</button>
						</div>
					</td>
				</tr>
				{% else %}
				<tr>
					<td colspan="8" class="text-center text-muted py-4">
						<i class="fa-solid fa-inbox fa-2x mb-2"></i><br>
						No payments found
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentDetailsModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Payment Details</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body" id="paymentDetailsContent">
				<!-- Content will be loaded here -->
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function exportToExcel() {
	// Simple Excel export using table data
	const table = document.getElementById('paymentTable');
	const rows = Array.from(table.querySelectorAll('tr'));
	
	let csvContent = "Date,Customer,Invoice No,Method,Amount,Reference,Status\n";
	
	rows.slice(1).forEach(row => {
		const cells = Array.from(row.querySelectorAll('td'));
		if (cells.length > 0) {
			const rowData = cells.map(cell => {
				let text = cell.textContent.trim();
				// Clean up text for CSV
				text = text.replace(/,/g, ';');
				text = text.replace(/\n/g, ' ');
				return `"${text}"`;
			});
			csvContent += rowData.join(',') + '\n';
		}
	});
	
	// Download CSV
	const blob = new Blob([csvContent], { type: 'text/csv' });
	const url = window.URL.createObjectURL(blob);
	const a = document.createElement('a');
	a.href = url;
	a.download = 'payment_history.csv';
	a.click();
	window.URL.revokeObjectURL(url);
}

function showPaymentDetails(paymentId) {
	// This would typically make an AJAX call to get payment details
	// For now, show a placeholder
	document.getElementById('paymentDetailsContent').innerHTML = `
		<div class="text-center">
			<i class="fa-solid fa-spinner fa-spin fa-2x mb-3"></i>
			<p>Loading payment details...</p>
		</div>
	`;
	
	const modal = new bootstrap.Modal(document.getElementById('paymentDetailsModal'));
	modal.show();
	
	// Simulate loading
	setTimeout(() => {
		document.getElementById('paymentDetailsContent').innerHTML = `
			<div class="alert alert-info">
				<i class="fa-solid fa-info-circle"></i>
				Payment details feature coming soon. This would show detailed payment information.
			</div>
		`;
	}, 1000);
}

document.addEventListener('DOMContentLoaded', function() {
	// Initialize DataTable with custom options
	if (document.querySelector('.datatable')) {
		$('.datatable').DataTable({
			pageLength: 25,
			lengthChange: false,
			order: [[0, 'desc']], // Sort by date descending
			columnDefs: [
				{ orderable: false, targets: [7] } // Disable sorting on Actions column
			]
		});
	}
});
</script>
{% endblock %}



